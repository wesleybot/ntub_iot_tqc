<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IoT 題庫 — 測驗</title>
  <link rel="icon" type="image/png" sizes="32x32" href="iot_web_icon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/quiz.css" rel="stylesheet">
</head>
<body id="top">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="index.html">TQC物聯網與雲端運算</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-label="切換導覽">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="iot_question.html">背題庫</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="quiz.html">測驗</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- 控制列 -->
  <div class="sticky-controls">
    <div class="container narrow">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-sm-6 col-lg-5">
          <label for="catSel" class="form-label mb-1">選擇大類</label>
          <select id="catSel" class="form-select">
            <option value="1">第一類</option>
            <option value="2">第二類</option>
            <option value="3">第三類</option>
            <option value="4">第四類</option>
            <option value="5">第五類</option>
            <option value="6">第六類</option>
          </select>
        </div>
        <div class="col-12 col-sm-auto">
          <div class="form-check mt-2 mt-sm-4">
            <input class="form-check-input" type="checkbox" id="shuffleChk">
            <label class="form-check-label" for="shuffleChk">打亂題目</label>
          </div>
        </div>
        <div class="col d-flex justify-content-sm-end mt-2 mt-sm-4 gap-2">
          <button id="startBtn" class="btn btn-success">開始測驗</button>
          <button id="submitBtn" class="btn btn-primary" disabled>提交答案</button>
          <button id="resetBtn" class="btn btn-outline-secondary">再次複習</button>
        </div>
      </div>
      <div id="status" class="text-muted small mt-2">
        請先選擇「大類」與是否「打亂題目」，再按「開始測驗」。
      </div>
    </div>
  </div>

  <!-- 題目列表與結果 -->
  <div class="container narrow">
    <div id="list" class="mt-3"></div>

    <div id="result" class="alert alert-info d-none mt-3"></div>

    <!-- 匯出工具列（提交後才顯示） -->
    <div id="exportBar" class="d-none mt-2">
      <div class="row g-2">
        <div class="col-12 col-sm-auto">
          <button id="downloadCsvBtn" class="btn btn-outline-primary w-100">下載 CSV</button>
        </div>
        <div class="col-12 col-sm-auto">
          <button id="downloadJsonBtn" class="btn btn-outline-dark w-100">下載 JSON</button>
        </div>
        <div class="col d-flex align-items-center">
          <div class="text-muted small">（含：大類、是否打亂、時間戳、每題題幹/選項/正解/作答/對錯）</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 回到頂部 -->
  <a href="#top" id="backToTop" class="btn btn-secondary shadow" aria-label="回到頂部">↑</a>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const catSel = document.getElementById('catSel');
    const shuffleChk = document.getElementById('shuffleChk');
    const listEl = document.getElementById('list');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultEl = document.getElementById('result');
    const backToTop = document.getElementById('backToTop');

    const exportBar = document.getElementById('exportBar');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');

    let currentQuestions = [];
    let revealed = false;
    let quizStarted = false;
    let userAnswersSnapshot = []; // 每題的使用者選項（提交時生成）
    let metaSnapshot = null;      // 匯出用的統計與設定

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    // 解析正解：支援 answer: "A" / "AC" / "A,C" / "A C" / "A、C"；相容 answers: ["A","C"]
    function parseCorrect(q){
      if (Array.isArray(q.answers) && q.answers.length > 0) {
        const arr = q.answers.map(s => String(s).trim().toUpperCase())
                             .filter(s => /^[A-D]$/.test(s))
                             .sort();
        return { multi: arr.length > 1, correct: arr };
      }
      const raw = String(q.answer || '').toUpperCase();
      const letters = raw.split(/[,\s、，]+/)
                         .join('')
                         .replace(/[^A-D]/g,'');
      const uniq = [...new Set(letters.split(''))].filter(x => x).sort();
      return { multi: uniq.length > 1, correct: uniq };
    }

    function fmtDateForFile(d=new Date()){
      const pad = n => String(n).padStart(2,'0');
      return d.getFullYear() + pad(d.getMonth()+1) + pad(d.getDate()) + '_' + pad(d.getHours()) + pad(d.getMinutes()) + pad(d.getSeconds());
    }

    async function loadCategory(cat){
      revealed = false;
      exportBar.classList.add('d-none');
      resultEl.classList.add('d-none');
      resultEl.textContent = '';
      listEl.innerHTML = '<div class="text-center text-muted py-4">載入中…</div>';
      submitBtn.disabled = true;

      const url = `iot_cat${cat}.json`;
      let data;
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('載入失敗');
        data = await res.json();
      }catch(e){
        listEl.innerHTML = `<div class="alert alert-danger">無法載入題庫：${e.message}</div>`;
        statusEl.textContent = '';
        return;
      }

      currentQuestions = Array.isArray(data.questions) ? [...data.questions] : [];
      if(shuffleChk.checked) shuffle(currentQuestions);

      renderQuestions(currentQuestions);
      statusEl.textContent = `已選擇：第 ${cat} 類；題數：${currentQuestions.length}；打亂：${shuffleChk.checked?'是':'否'}`;
      submitBtn.disabled = currentQuestions.length === 0;

      // 鎖定設定
      catSel.disabled = true;
      shuffleChk.disabled = true;
      startBtn.disabled = true;
      quizStarted = true;

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderQuestions(questions){
      const frag = document.createDocumentFragment();
      listEl.innerHTML = '';

      questions.forEach((q, idx) => {
        const { multi, correct } = parseCorrect(q);
        const name = `q_${idx}`;
        const qWrap = document.createElement('div');
        qWrap.className = 'q-item';

        // 題幹（加上單選/複選提示）
        const title = document.createElement('div');
        title.className = 'mb-2';
        const typeBadge = multi
          ? '<span class="badge text-bg-secondary ms-2">複選</span>'
          : '<span class="badge text-bg-secondary ms-2">單選</span>';
        title.innerHTML = `<strong>${idx+1}.</strong> ${q.question || ''} ${typeBadge}`;
        qWrap.appendChild(title);

        // 選項（保持 A-D 順序）
        const options = q.options || {};
        const letters = Object.keys(options).sort(); // A,B,C,D
        letters.forEach(letter => {
          const id = `${name}_${letter}`;
          const optDiv = document.createElement('div');
          optDiv.className = 'form-check opt';
          const input = document.createElement('input');
          input.className = 'form-check-input';
          input.type = multi ? 'checkbox' : 'radio';
          input.name = name;
          input.id = id;
          input.value = letter;

          const label = document.createElement('label');
          label.className = 'form-check-label';
          label.setAttribute('for', id);
          label.innerHTML = `<span class="badge bg-light text-body border badge-key">${letter}</span> ${options[letter] ?? ''} <span class="answer-mark d-none"></span>`;

          optDiv.appendChild(input);
          optDiv.appendChild(label);
          qWrap.appendChild(optDiv);
        });

        // metadata（統一以陣列存正解）
        qWrap.dataset.multi = multi ? '1' : '0';
        qWrap.dataset.correct = JSON.stringify(correct);

        // 額外存 options 文字（匯出方便）
        qWrap.dataset.options = JSON.stringify(options);

        frag.appendChild(qWrap);
      });

      listEl.appendChild(frag);
    }

    function evaluate(){
    if(revealed || !quizStarted) return;

    const items = Array.from(document.querySelectorAll('.q-item'));
    if (items.length === 0) return;

    let correctCount = 0;
    let answeredCount = 0;
    userAnswersSnapshot = [];

    items.forEach((wrap, idx) => {
      const inputs = Array.from(wrap.querySelectorAll('input'));
      const chosen = inputs.filter(i => i.checked).map(i => i.value);
      const correctAns = JSON.parse(wrap.dataset.correct || '[]'); // ["A","C"]
      const multi = wrap.dataset.multi === '1';
      const options = JSON.parse(wrap.dataset.options || '{}');

      if (chosen.length > 0) answeredCount++;

      // 判斷對錯
      let isRight = false;
      if(multi){
        const chosenSorted = [...chosen].sort();
        isRight = (correctAns.length === chosenSorted.length) && correctAns.every((v,i)=>v===chosenSorted[i]);
      }else{
        isRight = (chosen.length === 1 && chosen[0] === (correctAns[0] || ''));
      }
      if(isRight) correctCount++;

      // 視覺標示：把正確選項整列標成綠底，選錯的標紅底
      const optDivs = Array.from(wrap.querySelectorAll('.form-check'));
      optDivs.forEach(opt => {
        const input = opt.querySelector('input');
        const label = opt.querySelector('.form-check-label');
        const mark = label.querySelector('.answer-mark');
        const isCorrectOption = correctAns.includes(input.value);

        // 正確選項：加徽章＋綠底條
        if(isCorrectOption){
          mark.classList.remove('d-none');
          mark.innerHTML = `<span class="badge text-bg-success">正解</span>`;
          opt.classList.add('correct-option');
        }

        // 使用者選錯：紅底條
        if(input.checked && !isCorrectOption){
          opt.classList.add('wrong-chosen');
        }

        // 禁用避免更動
        input.disabled = true;
      });

      // 題目底下新增一行「正確答案：A、C（文字）」更明顯
      const letters = correctAns.join('、');
      const texts = correctAns.map(k => `${k}. ${options[k] ?? ''}`).join('；');
      const existed = wrap.querySelector('.correct-line');
      if(!existed){
        const line = document.createElement('div');
        line.className = 'correct-line';
        line.innerHTML = `正確答案：<span>${letters}</span>　<small>（${texts}）</small>`;
        wrap.appendChild(line);
      }

      // 匯出快照
      userAnswersSnapshot.push({
        index: idx + 1,
        question: wrap.querySelector('.mb-2')?.textContent?.replace(/^\d+\.\s*/, '').trim() || '',
        type: multi ? '複選' : '單選',
        options: options,
        correct: correctAns,
        chosen: chosen,
        answered: chosen.length > 0,
        isCorrect: isRight
      });
    });

    const wrongCount = answeredCount - correctCount;

    revealed = true;
    resultEl.classList.remove('d-none', 'alert-info');
    resultEl.classList.add('alert-success');
    resultEl.textContent = `作答完成：${answeredCount} / ${items.length}；答對 ${correctCount} 題、答錯 ${wrongCount} 題`;
    submitBtn.disabled = true;
    exportBar.classList.remove('d-none');

    metaSnapshot = {
      category: `第 ${catSel.value} 類`,
      shuffled: shuffleChk.checked,
      totalQuestions: items.length,
      answered: answeredCount,
      correct: correctCount,
      wrong: wrongCount,
      timestamp: new Date().toISOString()
    };

    resultEl.scrollIntoView({behavior:'smooth', block:'center'});
  }

    function showIntro(){
      listEl.innerHTML = `
        <div class="alert alert-light border mt-3">
          <div class="fw-semibold mb-1">如何開始？</div>
          <ol class="mb-0">
            <li>選擇「大類」</li>
            <li>勾選是否「打亂題目」</li>
            <li>按下 <span class="badge text-bg-success">開始測驗</span></li>
          </ol>
        </div>
      `;
    }

    function resetQuiz(){
      // 回初始 UI 與狀態
      quizStarted = false;
      revealed = false;
      currentQuestions = [];
      userAnswersSnapshot = [];
      metaSnapshot = null;

      catSel.disabled = false;
      shuffleChk.disabled = false;
      startBtn.disabled = false;
      submitBtn.disabled = true;

      // 選單回到預設
      catSel.value = "1";
      shuffleChk.checked = false;

      statusEl.textContent = '請先選擇「大類」與是否「打亂題目」，再按「開始測驗」。';
      resultEl.classList.add('d-none');
      resultEl.textContent = '';

      exportBar.classList.add('d-none');

      showIntro();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ===== 匯出：CSV / JSON =====
    function buildCsvText(meta, rows){
      const esc = (s) => {
        if (s === null || s === undefined) return '';
        const str = String(s);
        if (/[",\n]/.test(str)) return '"' + str.replace(/"/g,'""') + '"';
        return str;
      };

      // 首列：摘要
      const headerLines = [
        `類別,${esc(meta.category)}`,
        `是否打亂,${meta.shuffled ? '是' : '否'}`,
        `總題數,${meta.totalQuestions}`,
        `作答數,${meta.answered}`,
        `答對數,${meta.correct}`,
        `答錯數,${meta.wrong}`,
        `時間戳,${esc(meta.timestamp)}`
      ];

      // 欄位
      const columns = [
        '題號','單/複選','題目',
        'A','B','C','D',
        '正確答案','作答','是否作答','是否答對'
      ];

      const bodyLines = rows.map(r => {
        const opts = r.options || {};
        return [
          r.index,
          r.type,
          r.question,
          opts.A ?? '', opts.B ?? '', opts.C ?? '', opts.D ?? '',
          (r.correct || []).join(''),
          (r.chosen  || []).join(''),
          r.answered ? '是' : '否',
          r.isCorrect ? '是' : '否'
        ].map(esc).join(',');
      });

      return [
        headerLines.join('\n'),
        '',
        columns.join(','),
        bodyLines.join('\n')
      ].join('\n');
    }

    function downloadTextAsFile(text, filename){
      // 加上 BOM 讓 Excel 正確顯示 UTF-8
      const blob = new Blob(['\uFEFF', text], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    function onDownloadCsv(){
      if(!metaSnapshot || !userAnswersSnapshot.length) return;
      const csv = buildCsvText(metaSnapshot, userAnswersSnapshot);
      const fname = `iot_quiz_cat${catSel.value}_${fmtDateForFile()}.csv`;
      downloadTextAsFile(csv, fname);
    }

    function onDownloadJson(){
      if(!metaSnapshot || !userAnswersSnapshot.length) return;
      const payload = {
        meta: metaSnapshot,
        records: userAnswersSnapshot
      };
      const fname = `iot_quiz_cat${catSel.value}_${fmtDateForFile()}.json`;
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    // 事件
    startBtn.addEventListener('click', () => {
      if (quizStarted) return;
      loadCategory(catSel.value);
    });
    submitBtn.addEventListener('click', evaluate);
    resetBtn.addEventListener('click', resetQuiz);
    downloadCsvBtn.addEventListener('click', onDownloadCsv);
    downloadJsonBtn.addEventListener('click', onDownloadJson);

    // 回到頂部顯示/隱藏
    window.addEventListener('scroll', () => {
      backToTop.style.display = (window.scrollY > 200) ? 'inline-block' : 'none';
    });

    // 初始狀態：不載入題目
    showIntro();
  </script>
</body>
</html>
